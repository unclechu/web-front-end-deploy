#!/bin/bash
#
# Version: r1
# Author: Viacheslav Lotsmanov
# License: GNU/GPLv3 (https://github.com/unclechu/web-front-end-deploy/blob/master/LICENSE)
#
if [ -z "$PARENT_DEPLOY_SCRIPT" ]; then YOUR_SUBJECT="./_deploy/$(basename "$0")" WD="$(dirname "$0")/../" ../deploy.sh; exit "$?"; fi

info "Checking for installed all required node modules"

deps=$(cat package.json | tr '\n' ' ' | grep -o '"dependencies"\s*:\s*{[^}]*\s*}')

if [ $? -ne 0 ]; then
	err 1
	info_err_clean "Dependencies JSON-list not found in package.json "
	exit 1
else
	deps=$(echo "$deps" | sed -e 's/^"dependencies"\s*:\s*{\|\s*}$//g')
	deps=$(echo "$deps" | sed -e 's/\s*:\s*/:/g' | grep -o '"[^"]*":"[^"]*"')
	for item in ${deps[@]}; do
		key=$(echo "$item" | sed -e 's/"\([^"]*\)":"[^"]*"/\1/g' | sed -e 's/^\s\+\|\s\+$//g')
		if [ -n "$key" ]; then
			info_inline "Checking for node module \"$key\""
			if [ -d "./node_modules/$key" ]; then
				ok
			else
				err 1

				info_err_clean "Node module \"$key\" is not installed." \
					"You need to start \`${clr_info}npm install${clr_err}\`" \
					"before deploy."

				if ask "Start \`${clr_info}npm install${clr_ask}\` now?"; then
					if ! npm install; then exit 1; fi
					exit 0
				else
					info_clean "You need to start \`${clr_ask}npm install${clr_info}\` first. Exit..."
					exit 1
				fi

				exit 1
			fi
		fi
	done
fi
